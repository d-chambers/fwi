---
title: "GPGN 598A: Assignment #4"
subtitle: More Kernels
bibliography: references.bib
date: 2023-03-07
author:
  - name: Derrick Chambers
    url: https://derchambers.com
    affiliation: Colorado School of Mines
    affiliation-url: https://mines.edu

format:
  pdf:
    # toc: true
    # toc-depth: 1
    number-sections: true
    colorlinks: true
header-includes:
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
 \usepackage{amsmath}
---

# Abstract

The purpose of this assignment is to reproduce the simple SH example in @tromp2005seismic.



# True Model Development

In order to understand the kernels in the simplest cases, a 2D homogenous model
was selected with a single source and a single receiver. The model extents are from
0m to 4,000m in both dimensions and the elements are 50m by 50m. There are 9 points
in each direction. 

The source is located at x=1000, and z=2000 and the station is located at x=3000 and z=2000.
SpecFEM2D is then used to generate waveforms from the target model, referred to as the "observed"
seismograms. 


![Model and Source Receiver Geometry](outputs/a010_model_geometry.png){#fig-model width=300}


## Material Properties

The 2D model is composed of one elastic material which has the following properties: (@tbl-materials)

| Material  | $\rho (\frac{kg}{m^3})$ | $V_p (\frac{m}{s})$ | $V_s (\frac{m}{s})$ |
|:---------:|:-----------------------:|:-------------------:|:-------------------:|
|     1     |          2,700          |        3,000        |        1,820        |

: Materials {#tbl-materials}

Material attenuation was disabled.


## Boundary Conditions

Perfectly Matched Layers (PML) boundary conditions with 3 element thickness on all
sides. The attenuation parameters were left unchanged from the default
parameters file.

## Source

An explosion-type source was selected.
The source was located at x=1000m and z=2000m. A Ricker (2nd derivative of Gaussian)
source-time function was selected with a dominant frequency of 10Hz. This gives an
approximate maximum source frequency of 25Hz, which is the maximum recommended
frequency suggested by the SpecFEM2D output.


# Simulation Parameters

There were 25 nodes per element, corresponding to approximately 5 in each
direction. However, since GLLs are not evenly spaced, the average spacing
(as reported by SpecFEM2D) is 12.5m and the minimum spacing is 8.63m.

The Cartesian simulation is run in P-SV mode rather than SH/membrane wave mode. 

## CFL Stability

The reported max CFL stability condition for this simulation is 0.38 which is less
than the maximum recommended value of 0.5 so there shouldn't be any stability issues
related to the CFL condition in this case.

## Wavelength Resolution

Another important simulation consideration is wavelength resolution. SpecFEM2D
recommends an average number of GLLs per wavelength of 4.5 for S waves and
5.5 for P waves. This constraint is, of course, governed by the mesh spacing
and the lowest material velocity.

The number of GLLs per s-wave is 5.83. There is no distribution since all elements
are the same size. This is greater than the minimum recommended value of 4.5 (for S waves)
or 5.5 (for P waves), so there shouldn't be any resolution issues related to wavelength
sampling.


## Waveform pre-processing

The minimum and maximum frequencies resolvable by the model are 0.03 Hz and 29 Hz,
respectively. These frequencies are used to bandpass seismograms output by specfem before
calculating misfits or adjoint sources. The waveforms are also detrended using a linear fit
and tapered with a Han window with a maximum percentage of %5 using the functionality provided
by the ObsPy package [@beyreuther2010obspy].


# Initial model

The initial model is the base model with the S wave velocity decreased by 100 m/s. 

| Material | $\rho (\frac{kg}{m^3})$ | $V_p (\frac{m}{s})$ | $V_s (\frac{m}{s})$ |
|:--------:|:-----------------------:|:-------------------:|:-------------------:|
|    1'    |          2,700          |        2,900        |        1,820        |


# Procedure

To obtain the sensitivity kernels, the following procedure is employed:

1. Run forward simulation with the true model and store associated seismograms
2. Run forward simulation with the initial model and store associated seismograms/last frame of the wavefield
3. Calculate misfit between waveforms produced by the true and initial models and associated adjoint sources
4. Run adjoint simulation and visualize the associated kernels

The following sections show the different misfit functions and adjoint sources used.

# Waveform Misfit

The waveform misfit is defined as [@bozdaug2011misfit]:

$$
    \chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N 
    \int_0^T\left\|\mathbf{d}\left(\mathbf{x}_r, t\right)
    -\mathbf{s}\left(\mathbf{x}_r, t, \mathbf{m}\right)\right\|^2 
    \mathrm{~d} t
$${#eq-wf-misfit}

and the adjoint source as:

$$
    f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N \frac{1}{M_r}\left[d_i\left(\mathbf{x}_r, T-t\right)
    -s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right)\right] w_r(T-t) 
    \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-wf-adjoint}

@fig-wf-waveforms shows the "observed", synthetic, and adjoint source and
@fig-wf-kernel shows the associated kernel.

![Waveform Misfit: Waveforms and Adjoint Source](outputs/a040_wf_misfit_waveforms.png){#fig-wf-waveforms}

![Waveform Misfit: Kernel](outputs/a040_wf_kernel.png){#fig-wf-kernel}


# Traveltime Misfit

The cross-correlation traveltime misfit is defined as [@bozdaug2011misfit]:

$$
\chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N\left[T_r^{\mathrm{obs}}-T_r(\mathbf{m})\right]^2
$${#eq-tt-misfit}

and the adjoint source as:

$$
f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N\left[T_r^{\mathrm{obs}}-T_r(\mathbf{m})\right] \frac{1}{N_r} w_r(T-t) \partial_t s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right) \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-tt-adjoint}

@fig-tt-waveforms shows the "observed", synthetic, and adjoint source and
@fig-tt-kernel shows the associated kernel.

![Traveltime Misfit: Waveforms and Adjoint Source](outputs/a050_tt_misfit_waveforms.png){#fig-tt-waveforms}

![Traveltime Misfit: Kernel](outputs/a050_tt_kernel.png){#fig-tt-kernel}



# Amplitude Misfit

The amplitude misfit is defined as [@bozdaug2011misfit]:

$$
\chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N\left[\ln \frac{A_r^{\mathrm{obs}}}{A_r(\mathbf{m})}\right]^2
$${#eq-amp-misfit}

and the adjoint source as:

$$
f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N \ln \left[\frac{A_r^{\mathrm{obs}}}{A_r(\mathbf{m})}\right] \frac{1}{M_r} w_r(T-t) s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right) \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-ampo-adjoint}

@fig-amp-waveforms shows the "observed", synthetic, and adjoint source and
@fig-amp-kernel shows the associated kernel.

![Amplitude Misfit: Waveforms and Adjoint Source](outputs/a060_amp_misfit_waveforms.png){#fig-amp-waveforms}

![Amplitude Misfit: Kernel](outputs/a060_amp_kernel.png){#fig-amp-kernel}



# Discussion

Because potential stability and resolution issues were addressed, the simulation
worked without observable issues, meaning the produced seismograms are seem reasonable
and are free of obvious artifacts.

The calculated kernels to and those presented by @bozdaug2011misfit [Figure 6]
also show expected similarities. For example, for both waveform and traveltime
kernels [@fig-wf-kernel] the extreme values tend to occur on the outside of the 
"banana", whereas for the amplitude kernel more of the significant values occur
inside the banana.

It is interesting that the beta kernels are non-negligible for the 
waveform misfit kernel (@fig-wf-kernel) and the traveltime misfit kernel
(@fig-tt-kernel) even though no S waves should be generated by the simulation. I am
still thinking about why this might be the case and checking the codes for mistakes.

The density kernels, however, do appear to be negligible in all three cases, which
is expected.


# Supplemental Materials

The python code used to run specfem, calculate misfits and adjoint sources, as well as
visualize the kernels is submitted with this report in Canvas. The base specfem parameter
file is also included.


# References
