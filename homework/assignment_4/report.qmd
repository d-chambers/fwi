---
title: "GPGN 598A: Assignment #4"
subtitle: More Single-Station Kernels
bibliography: references.bib
date: 2023-03-23
author:
  - name: Derrick Chambers
    url: https://derchambers.com
    affiliation: Colorado School of Mines
    affiliation-url: https://mines.edu

format:
  pdf:
    # toc: true
    # toc-depth: 1
    number-sections: true
    colorlinks: true
header-includes:
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
 \usepackage{amsmath}
---

# Abstract

The purpose of this assignment is to reproduce the simple SH example in @tromp2005seismic.


# Prompt

As we discussed during the class last week please extend previous assignment toward computing an event kernel:

First, compute S and SS kernels by mimicking the 2D example given in Tromp et al. 2005.
Use SPECFEM2D in the SH mode for a homogeneous model and compute S and SS kernels together using;

a) cross-correlation traveltime kernels (note that you need to window S and SS waves separately),
b) waveform misfit (use the same windows you use for traveltime kernels, also use one big window
to observe the window effect on measurements).


# Simulation and Model Description

In order to understand the kernels in the simplest cases, a 2D homogenous model
was selected with a single source and a single receiver. The model is based on
the first example in @tromp2005seismic, but some parameters were altered slightly
or estimated if not provided in the paper. A few of the key parameters are shown in
the following table, and the complete data inputs are attached to this report.


|       Parameter        |     Value      | Units |
|:----------------------:|:--------------:|:-----:|
|        timestep        |       2        |  ms   |
|   timesteping scheme   |    Newmark     |       |
|          mode          |       SH       |       |
|  x extents (min/max)   |    0 / 200     |  km   |
|  z extents (min/max)   |     0 / 80     |  km   |
| source location (x/z)  |  50.0 / 40.0   |  km   |
|      source type       | vertical force |       |
| station location (x/z) |  150.0 / 40.0  |  km   |



Absorbing boundary conditions are used for all sides except the top which is a free surface.



## Material Properties

The 2D model is composed of one elastic material which has the following properties:

| Material  | $\rho (\frac{kg}{m^3})$ | $V_p (\frac{m}{s})$ | $V_s (\frac{m}{s})$ |
|:---------:|:-----------------------:|:-------------------:|:-------------------:|
|     1     |          2,600          |        5,800        |        3,200        |

: True Material Properties {#tbl-true-materials}

Material attenuation was disabled.


## Boundary Conditions

Perfectly Matched Layers (PML) boundary conditions with 3 element thickness on all
sides. The attenuation parameters were left unchanged from the default
parameters file. The top of the model (Z=0) was set as a free surface.


# Simulation Parameters

There were 25 nodes per element, corresponding to approximately 5 in each
direction. However, since GLLs are not evenly spaced, the average spacing
(as reported by SpecFEM2D) is 625m and the minimum spacing is 431m.

The Cartesian simulation is run in P-SV mode rather than SH/membrane wave mode.

## CFL Stability

The reported max CFL stability condition for this simulation is 0.27 which is less
than the maximum recommended value of 0.5 so there shouldn't be any stability issues
related to the CFL condition in this case.

## Wavelength Resolution

SpecFEM2D recommends an average number of GLLs per wavelength of 4.5 for S waves and
5.5 for P waves. This constraint is, of course, governed by the mesh spacing
and the lowest material velocity.

The minimum number of GLLs per s-wave is 4.83, which is above the recommend value of 4.5
so there shouldn't be any resolution issues. All elements are in solid regions.


## Waveform pre-processing

The maximum frequencies resolvable by the model is 1.02 Hz, so a low-pass filter is applied
at this frequency. The waveforms are also detrended using a linear fit
and tapered with a Han window with a maximum percentage of %5 using the functionality provided
by the ObsPy package [@beyreuther2010obspy].

This preprocessing of waveforms is applied before calculating misfit functions and adjoint sources.


# Initial model

The initial model is the base model with the S wave velocity decreased by about 2.5%.

| Material  | $\rho (\frac{kg}{m^3})$ | $V_p (\frac{m}{s})$ | $V_s (\frac{m}{s})$ |
|:---------:|:-----------------------:|:-------------------:|:-------------------:|
|     1     |          2,600          |        5,800        |        3,120        |

: Initial Material Properties {#tbl-initial-materials}

# Procedure

To obtain the sensitivity kernels, the following procedure is employed:

1. Run forward simulation with the true model and store associated seismograms
2. Run forward simulation with the initial model and store associated seismograms/last frame of the wavefield
3. Calculate misfit between waveforms produced by the true and initial models and associated adjoint sources
4. Run adjoint simulation and visualize the associated kernels

The procedure is carried out for both S and SS phases separately, then for the whole
waveform for each misfit function highlighted in the next section.


## Waveform Misfit

The waveform misfit is defined as [@bozdaug2011misfit]:

$$
    \chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N
    \int_0^T\left\|\mathbf{d}\left(\mathbf{x}_r, t\right)
    -\mathbf{s}\left(\mathbf{x}_r, t, \mathbf{m}\right)\right\|^2
    \mathrm{~d} t
$${#eq-wf-misfit}

and the adjoint source as:

$$
    f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N \frac{1}{M_r}\left[d_i\left(\mathbf{x}_r, T-t\right)
    -s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right)\right] w_r(T-t)
    \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-wf-adjoint}


## Traveltime Misfit

The cross-correlation traveltime misfit is defined as [@bozdaug2011misfit]:

$$
\chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N\left[T_r^{\mathrm{obs}}-T_r(\mathbf{m})\right]^2
$${#eq-tt-misfit}

and the adjoint source as:

$$
f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N\left[T_r^{\mathrm{obs}}-T_r(\mathbf{m})\right] \frac{1}{N_r} w_r(T-t) \partial_t s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right) \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-tt-adjoint}


# Results

## Wavefroms

The resulting "true" and "initial" waveforms recorded by the station are shown in
@fig-waveforms, in addition to the windows used for the S and SS phase respectively.


![True and Initial Waveforms (Y component)](outputs/a030_waveform_plot.png){#fig-waveforms}


@fig-wf-s and @fig-wf-ss show the waveform misfit kernels for S and SS phases respectively.


![Waveform misfit kernel S phase](outputs/a070_kernel_plots/waveform_S.png){#fig-wf-s}


![Waveform misfit kernel SS phase](outputs/a070_kernel_plots/waveform_SS.png){#fig-wf-ss}

![Waveform misfit kernel complete](outputs/a070_kernel_plots/waveform_Whole.png){#fig-wf-whole}


@fig-tt-s and @fig-tt-ss show the travel-time misfit kernels for S and SS phases
respectively.


![Travel time misfit kernel S phase](outputs/a070_kernel_plots/travel_time_S.png){#fig-tt-s}


![Travel time misfit kernel SS phase](outputs/a070_kernel_plots/travel_time_SS.png){#fig-tt-ss}


![Travel time misfit kernel complete](outputs/a070_kernel_plots/travel_time_Whole.png){#fig-tt-whole}


# Discussion

The waveforms (@fig-waveforms) appear free of significant numerical issues and since the CFL and
waveform resolution criteria were met, the model is likely free from significant
stability or resolution artefacts.

However, there are some artefacts visible in each of the kernels due to imperfect
absorbing boundary conditions. These are particularly visible in the SS kernels
(@fig-wf-ss and @fig-tt-ss) where a faint reflection of the "bunny ears" kernel is
observed if reflected over the source-receiver line. The side lobes (the hyperbola
to the left of the source and the right of the station) are also suspect, since
the main ray paths should only travel between the stations. These may be due to
reflections from the imperfect boundaries on the right/left sides, or perhaps
some data processing artefact. However, these also occur in the figures presented
by @tromp2005seismic so it is not an issue unique to this implementation.

The benefits of windowing here are well illustrated by comparing the whole waveform
kernels with the windowed kernels; smaller phases, such as SS, receive less weight
and thus appear fainter in @fig-tt-whole and @fig-wf-whole than when seperated into
their own kernels. The difference in kernel amplitude is more pronounced for the
waveform kernels, but also appears in the travel time kernels. If the difference in
energy were even greater, this emphasis and de-emphasis would be even greater,
leading the higher amplitude waves to dominate the kernels. Of cousre, and
especially in real-world data that can be dominated by surface waves, this is often
not desirable, hence the need for windowing.


# Supplemental Materials

The python code used to run specfem, calculate misfits and adjoint sources, as well as
visualize the kernels is submitted with this report in Canvas. The base specfem parameter
file is also included.

# References
