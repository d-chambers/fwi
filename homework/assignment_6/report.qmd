---
title: "GPGN 598A: Assignment #6"
subtitle: Ray Tomography
bibliography: references.bib
date: 2023-04-07
author:
  - name: Derrick Chambers
    url: https://derchambers.com
    affiliation: Colorado School of Mines
    affiliation-url: https://mines.edu

format:
  pdf:
    # toc: true
    # toc-depth: 1
    number-sections: true
    colorlinks: true
header-includes:
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
 \usepackage{amsmath}
---

# Abstract

The purpose of this assignment is to explore ray-based tomography techniques
for estimating earth structure.

# Forward Problem

## Model Parameterization

For this assignment, perturbations of the current earth model 
are described in terms of $M$ basis functions:

$$
\delta ln(c(x)) = \sum_{k=1}^{M} \delta m_k B_k (x)
$${#eq-peturb}

In this case, the basis functions selected ($B_k$) are the spherical splines of 
@wang1995spherical. 

::: {.callout-note appearance="simple"}

## Question 1a

What is the value of the q = 8 spline function that is centered at (longitude, latitude)
= ($−117^{\circ}$ , $34^{\circ}$ ), evaluated at the point ($−117.05^{\circ}$ , $34.25^{\circ}$ )?

:::

```{python}
from raytape import spline_vals

out = spline_vals(
    clon=-117,
    clat=34,
    scale=8,
    lon_vec=[-117.05],
    lat_vec=[34.25],
    cols=1,
)
print(out[0][0])
```


::: {.callout-note appearance="simple"}

## Question 1b

Formulate an entry of the design matrix. From the class notes, the ray theory travel-
time perturbation for the ith source-receiver combination is given by

$$
\delta T_i = - \int_{ray_i} c^{-1} \delta ln(c) ds,
$${#eq-dT}

where ds denotes a segment of the ith ray. Show how this leads to $d = G \delta m$, 
where the data vector is given by

$$
d = (\delta T_{1} , . . . , \delta T_{i} , . . . , \delta T_{N} )^{T},
$${#eq-d}

and write the expression for the $G_{ik}$ element of the design matrix $G$.
:::

To derive an expression for $G_{ik}$ we can work backwards by substituting 
@eq-peturb into @eq-d. 

$$
\delta T_{i} = \int_{ray_i} c^{-1} \sum_{k=1}^{M} \delta m_k B_k (x) ds
$$

And since the summation term can be rewritten in terms of a dot product
(using Einstein's summation notation)

$$
\delta T_{i} = \int_{ray_i} c^{-1} B_k  ds  \cdot \delta m_k  
$$

Hence,

$$
G_{ik} = \int_{ray_i} c^{-1} B_k  ds
$${#eq-gik}

and thus it follows:

$$
d = G \delta m
$$

::: {.callout-note appearance="simple"}

## Question 1c

What is the value of G ik with i = 126 and k = 204? What does each row of G
correspond to? What does each column of G correspond to?

:::


```{python}
import numpy as np

ar = np.load("outputs/G.npy")
print(ar[126, 204])
print(ar[125, 203])
```

Each row of G corresponds to a particular ray and each column corresponds to the value
of a spline basis function.

:::{callout-note}
Because python indexing starts at 0, and Matlab's starts at 1, I have printed both
the G value for the requested index and the previous index (which will match the
Matlab answer.) 
:::

To double check the values in the G matrix, I created several plots of random ray paths
showing a straight-line from source to receiver and the values of the effected spline
functions. @fig-ray-path shows one such example. After plotting approximately 100
ray paths, I am convinced the G matrix contains reasonable values because the splines
nearest the ray path have the highest values with smoothly varying values away from
the ray path.

![Example Ray Path and G values.](outputs/ray_plots/0282.png){#fig-ray-path}


:::{.callout-note appearance="simple"}

# Question 2a

Write the symbolic expression for the solution δm to the least squares problem Gδm =
d in the case where GT G is full rank. List the dimensions of δm, d, G, GT G, and
GT d

:::

Assuming G is full rank and thus doesn't require damping/conditioning:

$$
G \delta m = d
$$

$$
G^T G \delta m = G^T d
$$

$$
\delta m = (G^T G)^{-1} G^T d
$${#eq-delta_m}

The dimensions of the requested symbols are as follows:

| Symbol     | Dimensions | 
|------------|------------|
| $\delta$ m | k x 1      |
| $d$        | i x 1      |
| $G$        | i x k      |
| $G^T G$    | k x k      |
| $G^T d$    | k x 1      |



:::{.callout-note appearance="simple"}

# Question 2c

Compute δm using the formula above. What do you get, and why is this the case?
:::

The above operation isn't possible; the appropriate linear algebra inverse function
raising an error stating that the matrix $G^T G$ is a singular matrix.


# References