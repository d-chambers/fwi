---
title: "GPGN 598A: Assignment #3"
subtitle: Calculating Adjoint Kernels
bibliography: references.bib
date: 2023-03-04
author:
  - name: Derrick Chambers
    url: https://derchambers.com
    affiliation: Colorado School of Mines
    affiliation-url: https://mines.edu

format:
  pdf:
    # toc: true
    # toc-depth: 1
    number-sections: true
    colorlinks: true
header-includes:
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
 \usepackage{amsmath}
---

# Abstract

The purpose of this assignment is to use SpecFEM2D to calculate kernels
for three misfit functions:

a) the cross-correlation traveltime misfit,

b) the cross-correlation amplitude misfit,

c) the waveform misfit.

In addition, the report should address the following:

1- figures of your model, source-receiver configuration, computed seismograms, adjoint sources and adjoint kernels,

2- the parameter file you used during your simulations,

3- the resolution of your simulations (i.e., min resolvable period by your mesh),

4- the corner frequencies of your band-pass or low-pass filter.

5- what kind of seismic source you use,

6- are you using the numerical solver in the SH or P-SV mode,

7- your interpretation and comments.

# True Model Development

In order to understand the kernels in the simplest cases, a 2D homogenous model
was selected with a single source and a single receiver. The model extents are from
0m to 4,000m in both dimensions and the elements are 50m by 50m. There are 9 points
in each direction. 

The source is located at x=1000, and z=2000 and the station is located at x=3000 and z=2000.


![Model and Source Receiver Geometry](outputs/a010_model_geometry.png){#fig-model width=300}


## Material Properties

The 2D model is composed of one elastic material which has the following properties: (@tbl-materials)

| Material  | $\rho (\frac{kg}{m^3})$ | $V_p (\frac{m}{s})$ | $V_s (\frac{m}{s})$ |
|:---------:|:-----------------------:|:-------------------:|:-------------------:|
|     1     |          2,700          |        3,000        |        1,820        |

: Materials {#tbl-materials}

Material attenuation was disabled.

## Geometry and Grid Discretization

The model is a basic layered-cake model with flat interfaces between boundaries
with hypothetical topography applied in the most shallow layer.

The Total model extents are 4000m in the x direction and the Z extents
range from $\approx$ 3000m to 3350m depending on the topography. The total number
of elements in the x direction in 100 and in the z direction is 75. This means
each element is approximately 40m by 40m.

## Boundary Conditions

Perfectly Matched Layers (PML) boundary conditions with 3 element thickness on all
sides. The default attenuation parameters were left unchanged from the default
parameters file.

## Source

An explosion-type source was selected.
The source was located at x=1000m and z=2000m. A Ricker (2nd derivative of Gaussian)
source-time function was selected with a dominant frequency of 10Hz. This gives an
approximate maximum source frequency of 25Hz, which is the maximum recommended
frequency suggested by the SpecFEM2D output.

## Receivers

Again, as single source is located at  x=3000 and z=2000 in the homogeneous model.

# Simulation Parameters

There were 25 nodes per element, corresponding to approximately 5 in each
direction. However, since GLLs are not evenly spaced, the average spacing
(as reported by SpecFEM2D) is 12.5m and the minimum spacing is 8.63m.

The simulation is run in P-SV mode rather than SH/membrane wave mode. It is
Cartesian Planar simulation.

## CFL Stability

The reported max CFL stability condition for this simulation is 0.38 which is less
than the maximum recommended value of 0.5 so there shouldn't be any stability issues
related to the CFL condition in this model.

## Wavelength Resolution

Another important simulation consideration is wavelength resolution. SpecFEM2D
recommends an average number of GLLs per wavelength of 4.5 for S waves and
5.5 for P waves. This constraint is, of course, governed by the mesh spacing
and the lowest material velocity.

The number of GLLs per s-wave is 5.83. There is no distribution since all elements
are the same size. This is greater than the minimum recommended value of 4.5 (for S waves)
or 5.5 (for P waves), so there shouldn't be any resolution issues related to wavelength
sampling.


## Bandwidth

The minimum and maximum frequencies removable by the model are 0.03 Hz and 29 Hz,
respectively. These frequencies will be used to bandpass seismograms as part of the
pre-processing step.


# Initial model

The initial model is the base model with the S wave velocity decreased by 50 m/s. 

| Material | $\rho (\frac{kg}{m^3})$ | $V_p (\frac{m}{s})$ | $V_s (\frac{m}{s})$ |
|:--------:|:-----------------------:|:-------------------:|:-------------------:|
|    1'    |          2,700          |        2,900        |        1,820        |


# Kernel Procedure

To obtain the sensitivity kernels, the following procedure is employed:

1. Run forward simulation with the true model and store associated seismograms
2. Run forward simulation with the initial model and store associated seismograms/last frame of the wavefield
3. Calculate misfit between waveforms produced by the true and initial models and associated adjoint sources
4. Run adjoint simulation and visualize the associated kernels

The following sections show the different misfit functions and adjoint sources.

# Waveform Misfit

The waveform misfit is defined as [@bozdaug2011misfit]:

$$
    \chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N 
    \int_0^T\left\|\mathbf{d}\left(\mathbf{x}_r, t\right)
    -\mathbf{s}\left(\mathbf{x}_r, t, \mathbf{m}\right)\right\|^2 
    \mathrm{~d} t
$${#eq-wf-misfit}

and the adjoint source as:

$$
    f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N \frac{1}{M_r}\left[d_i\left(\mathbf{x}_r, T-t\right)
    -s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right)\right] w_r(T-t) 
    \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-wf-adjoint}

@fig-wf-waveforms shows the "observed", synthetic, and adjoint source and
@fig-wf-kernel shows the associated kernel.

![Waveform Misfit: Waveforms and Adjoint Source](outputs/a040_wf_misfit_waveforms.png){#fig-wf-waveforms}

![Waveform Misfit: Kernel](outputs/a040_wf_kernel.png){#fig-wf-kernel}


# Traveltime Misfit

The cross-correlation traveltime misfit is defined as [@bozdaug2011misfit]:

$$
\chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N\left[T_r^{\mathrm{obs}}-T_r(\mathbf{m})\right]^2
$${#eq-tt-misfit}

and the adjoint source as:

$$
f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N\left[T_r^{\mathrm{obs}}-T_r(\mathbf{m})\right] \frac{1}{N_r} w_r(T-t) \partial_t s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right) \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-tt-adjoint}

@fig-tt-waveforms shows the "observed", synthetic, and adjoint source and
@fig-tt-kernel shows the associated kernel.

![Traveltime Misfit: Waveforms and Adjoint Source](outputs/a050_tt_misfit_waveforms.png){#fig-tt-waveforms}

![Traveltime Misfit: Kernel](outputs/a050_tt_kernel.png){#fig-tt-kernel}



# Amplitude Misfit

The amplitude misfit is defined as [@bozdaug2011misfit]:

$$
\chi(\mathbf{m})=\frac{1}{2} \sum_{r=1}^N\left[\ln \frac{A_r^{\mathrm{obs}}}{A_r(\mathbf{m})}\right]^2
$${#eq-amp-misfit}

and the adjoint source as:

$$
f_i^{\dagger}(\mathbf{x}, t)=-\sum_{r=1}^N \ln \left[\frac{A_r^{\mathrm{obs}}}{A_r(\mathbf{m})}\right] \frac{1}{M_r} w_r(T-t) s_i\left(\mathbf{x}_r, T-t, \mathbf{m}\right) \delta\left(\mathbf{x}-\mathbf{x}_r\right)
$${#eq-ampo-adjoint}

@fig-amp-waveforms shows the "observed", synthetic, and adjoint source and
@fig-amp-kernel shows the associated kernel.

![Amplitude Misfit: Waveforms and Adjoint Source](outputs/a060_amp_misfit_waveforms.png){#fig-amp-waveforms}

![Amplitude Misfit: Kernel](outputs/a060_amp_kernel.png){#fig-amp-kernel}



# Discussion

Because potential stability and resolution issues were addressed, the simulation
worked without major issues. The produced seismograms are reasonable.

The calculated kernels to and those presented by @bozdaug2011misfit [Figure 6]
also show expected similarities. For example, for both waveform and traveltime
kernels [@fig-wf-kernel] the extreme values tend to occur on the outside of the 
"banana", whereas for the amplitude kernel more of the significant values occur
inside the banana.

It is interesting that the beta kernels are non-negligible for the 
waveform misfit kernel (@fig-wf-kernel) and the traveltime misfit kernel
(@fig-tt-kernel) even though no S waves should be generated by the simulation. I am
still thinking about why this might be the case and checking the codes for mistakes.



# Supplemental Materials

The python code used to run specfem, calculate misfits and adjoint sources, as well as
visualize the kernels is submitted with this report in Canvas.


# References
